// This connects to your Supabase Postgres instance
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  // Who is booking?
  userEmail String
  userName  String?

  // When?
  startTime DateTime
  endTime   DateTime  // This determines the price

  // Payment Status
  status          BookingStatus @default(PENDING)
  totalPrice      Int           // Stored in cents (e.g. 2000 = 20.00€)
  stripeSessionId String?       @unique // To link back to Stripe
}

enum BookingStatus {
  PENDING   // Reserved for 10 mins, waiting for payment
  PAID      // Payment confirmed via Webhook
  FAILED    // Payment failed or timed out
  CANCELLED
}

// 1. DATABASE EXTENSION
model CostBenchmark {
  id                        String @id @default(cuid())
  category                  String
  unitPriceM2               Float
  expectedLifeYears         Int
  technicalDepreciationRate Float
  updatedAt                 DateTime @updatedAt
}

model FinancialScenario {
  id                 String @id @default(cuid())
  title              String
  totalLoanAmount    Float
  interestRate       Float
  termYears          Int
  monthlyImpactPerM2 Float
  createdAt          DateTime @default(now())
}

// NEW: Investment Grade Analysis
model HousingCompany {
  id              String           @id @default(cuid())
  businessId      String           @unique // e.g. "1234567-8"
  name            String
  constructionYear Int
  apartmentCount  Int
  totalAreaM2     Float
  
  investmentGrades  InvestmentGrade[]
  renovationProjects RenovationProject[]
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model InvestmentGrade {
  id               String         @id @default(cuid())
  
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  
  score            Float          // 0-100
  grade            String         // A, B, C, D, E
  
  // Stores breakdown of Repair Debt, Funding, Energy, Governance
  // Structure: { repairDebt: number, funding: number, energy: number, governance: number }
  pillarScores     Json
  
  updatedAt        DateTime       @updatedAt
}

// NEW: Renovation & Documentation
model RenovationProject {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  
  name             String
  description      String?
  estimatedCost    Float
  startYear        Int
  
  type             ProjectType    @default(TRADITIONAL)
  
  documents        Document[]
  loanApplications LoanApplication[]
  
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

enum ProjectType {
  TRADITIONAL
  ENERGY_EFFICIENCY
}

model Document {
  id                  String            @id @default(cuid())
  renovationProjectId String
  renovationProject   RenovationProject @relation(fields: [renovationProjectId], references: [id])
  
  title               String // e.g. "Yhtiökokouksen pöytäkirja"
  type                DocumentType
  url                 String // Storage URL
  isSigned            Boolean @default(false)
  
  uploadedAt          DateTime @default(now())
}

enum DocumentType {
  MEETING_MINUTES
  TECHNICAL_PLAN
  BUDGET
  OTHER
}

// NEW: Bank Loan Bridge
model LoanApplication {
  id              String        @id @default(cuid())
  
  projectId       String        
  project         RenovationProject @relation(fields: [projectId], references: [id])
  
  bankName        String        // e.g. "Nordea", "OP", "Danske Bank"
  amountRequested Float
  
  status          LoanStatus    @default(DRAFT)
  
  offerMargin     Float?        // e.g. 0.85 (%)
  repaymentTerm   Int?          // Years
  collateralType  String?       // e.g. "Mortgage deeds", "Guarantee"
  
  isGreenLoan     Boolean       @default(false)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum LoanStatus {
  DRAFT
  SUBMITTED
  OFFER_RECEIVED
  REJECTED
  ACTIVE
}
