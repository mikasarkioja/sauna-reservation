{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MikaS%C3%A4rkioja/Documents/Ty%C3%B6kansio/Cursor/SaunaReservation/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\n\r\nconst prismaClientSingleton = () => {\r\n  return new PrismaClient()\r\n}\r\n\r\ntype PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClientSingleton | undefined\r\n}\r\n\r\nconst prisma = globalForPrisma.prisma ?? prismaClientSingleton()\r\n\r\nexport default prisma\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,wBAAwB;IAC5B,OAAO,IAAI,6IAAY;AACzB;AAIA,MAAM,kBAAkB;AAIxB,MAAM,SAAS,gBAAgB,MAAM,IAAI;uCAE1B;AAEf,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 57, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MikaS%C3%A4rkioja/Documents/Ty%C3%B6kansio/Cursor/SaunaReservation/src/lib/stripe.ts"],"sourcesContent":["import Stripe from 'stripe';\r\n\r\nif (!process.env.STRIPE_SECRET_KEY) {\r\n  throw new Error('STRIPE_SECRET_KEY is missing. Please set it in your .env file.');\r\n}\r\n\r\nexport const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\r\n  apiVersion: '2024-11-20.acacia', // Use the latest API version or the one matching the installed package\r\n  typescript: true,\r\n});\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;IAClC,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,SAAS,IAAI,iKAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;IAC9D,YAAY;IACZ,YAAY;AACd"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MikaS%C3%A4rkioja/Documents/Ty%C3%B6kansio/Cursor/SaunaReservation/src/lib/pricing.ts"],"sourcesContent":["export const PRICING_PER_30_MINS_CENTS = 1000; // 10.00€\r\nexport const MIN_DURATION_MINUTES = 60;\r\n\r\nexport class PricingError extends Error {\r\n  constructor(message: string) {\r\n    super(message);\r\n    this.name = 'PricingError';\r\n  }\r\n}\r\n\r\n/**\r\n * Calculates the sauna reservation price based on start and end time.\r\n * \r\n * Rules:\r\n * - Minimum reservation is 1 hour.\r\n * - Pricing is 10€ per 30-minute block.\r\n * - Duration must be a multiple of 30 minutes.\r\n * \r\n * @param start Start date of the reservation\r\n * @param end End date of the reservation\r\n * @returns Price in cents\r\n * @throws PricingError if validation fails\r\n */\r\nexport function calculateSaunaPrice(start: Date, end: Date): number {\r\n  const startTime = start.getTime();\r\n  const endTime = end.getTime();\r\n\r\n  if (endTime <= startTime) {\r\n    throw new PricingError('End time must be after start time.');\r\n  }\r\n\r\n  const durationMs = endTime - startTime;\r\n  const durationMinutes = durationMs / (1000 * 60);\r\n\r\n  // 1. Validate minimum duration\r\n  if (durationMinutes < MIN_DURATION_MINUTES) {\r\n    throw new PricingError(`Minimum reservation time is ${MIN_DURATION_MINUTES / 60} hour(s).`);\r\n  }\r\n\r\n  // 2. Validate 30-minute blocks\r\n  if (durationMinutes % 30 !== 0) {\r\n    throw new PricingError('Reservation duration must be in 30-minute increments.');\r\n  }\r\n\r\n  // 3. Calculate price\r\n  const blocks = durationMinutes / 30;\r\n  const priceCents = blocks * PRICING_PER_30_MINS_CENTS;\r\n\r\n  return priceCents;\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,4BAA4B,MAAM,SAAS;AACjD,MAAM,uBAAuB;AAE7B,MAAM,qBAAqB;IAChC,YAAY,OAAe,CAAE;QAC3B,KAAK,CAAC;QACN,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAeO,SAAS,oBAAoB,KAAW,EAAE,GAAS;IACxD,MAAM,YAAY,MAAM,OAAO;IAC/B,MAAM,UAAU,IAAI,OAAO;IAE3B,IAAI,WAAW,WAAW;QACxB,MAAM,IAAI,aAAa;IACzB;IAEA,MAAM,aAAa,UAAU;IAC7B,MAAM,kBAAkB,aAAa,CAAC,OAAO,EAAE;IAE/C,+BAA+B;IAC/B,IAAI,kBAAkB,sBAAsB;QAC1C,MAAM,IAAI,aAAa,CAAC,4BAA4B,EAAE,uBAAuB,GAAG,SAAS,CAAC;IAC5F;IAEA,+BAA+B;IAC/B,IAAI,kBAAkB,OAAO,GAAG;QAC9B,MAAM,IAAI,aAAa;IACzB;IAEA,qBAAqB;IACrB,MAAM,SAAS,kBAAkB;IACjC,MAAM,aAAa,SAAS;IAE5B,OAAO;AACT"}},
    {"offset": {"line": 117, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MikaS%C3%A4rkioja/Documents/Ty%C3%B6kansio/Cursor/SaunaReservation/src/app/actions/create-booking.ts"],"sourcesContent":["'use server';\n\nimport prisma from '../../lib/prisma';\nimport { stripe } from '../../lib/stripe';\nimport { calculateSaunaPrice, PricingError } from '../../lib/pricing';\nimport { BookingStatus } from '@prisma/client';\n\n/**\n * Interface for the booking request payload\n */\ninterface CreateBookingRequest {\n  userEmail: string;\n  userName?: string;\n  startTime: string; // ISO string\n  endTime: string;   // ISO string\n}\n\n/**\n * Interface for the server action response\n */\ninterface CreateBookingResponse {\n  success: boolean;\n  url?: string;\n  error?: string;\n}\n\n/**\n * Server Action to create a sauna booking.\n * \n * Flow:\n * 1. Validate inputs and calculate price.\n * 2. Check for availability (concurrency handling).\n * 3. Create PENDING booking in DB.\n * 4. Create Stripe Checkout Session.\n * 5. Update booking with Stripe Session ID.\n * 6. Return Stripe URL.\n */\nexport async function createBooking(data: CreateBookingRequest): Promise<CreateBookingResponse> {\n  try {\n    const start = new Date(data.startTime);\n    const end = new Date(data.endTime);\n    const { userEmail, userName } = data;\n\n    console.log('DEBUG: NEXT_PUBLIC_APP_URL is:', process.env.NEXT_PUBLIC_APP_URL); // Debug log\n\n    // 1. Basic Validation\n    if (!userEmail) {\n      throw new Error('User email is required.');\n    }\n    \n    // Validate dates and calculate price\n    // This throws PricingError if invalid\n    const priceInCents = calculateSaunaPrice(start, end);\n\n    // 2. Availability Check & Reservation (Concurrency Handling)\n    // \n    // CONCURRENCY EXPLANATION:\n    // The \"Check-Then-Act\" race condition occurs when two requests check for availability \n    // at the same time, both see the slot as free, and both insert a booking.\n    //\n    // To solve this in a robust production environment, we have a few options:\n    // A) Postgres Exclusion Constraints: Add a constraint to the DB to physically prevent overlapping time ranges (best).\n    // B) Serializable Transactions: Run the transaction with 'Serializable' isolation level.\n    // C) Table Locking: Lock the table (bad for performance).\n    //\n    // Here, we use a Prisma transaction to group the check and the insert. \n    // Ideally, we would use `isolationLevel: 'Serializable'`, but that requires retry logic as serialization failures are expected.\n    // For this scaffold, we perform a check for overlapping bookings within the transaction. \n    // Note: Without Serializable isolation or Exclusion constraints, a race condition is still theoretically possible \n    // if the DB isolation level is Read Committed (default).\n    \n    const booking = await prisma.$transaction(async (tx) => {\n      // Check for overlapping bookings that are NOT failed/cancelled\n      // Overlap logic: (StartA < EndB) and (EndA > StartB)\n      const existingBooking = await tx.booking.findFirst({\n        where: {\n          AND: [\n            { startTime: { lt: end } },\n            { endTime: { gt: start } },\n            {\n              status: {\n                in: [BookingStatus.PENDING, BookingStatus.PAID],\n              },\n            },\n          ],\n        },\n      });\n\n      if (existingBooking) {\n        throw new Error('The selected time slot is already booked.');\n      }\n\n      // Create PENDING booking\n      return tx.booking.create({\n        data: {\n          userEmail,\n          userName,\n          startTime: start,\n          endTime: end,\n          totalPrice: priceInCents,\n          status: BookingStatus.PENDING,\n        },\n      });\n    });\n\n    // 3. Create Stripe Checkout Session\n    // We do this AFTER creating the booking record so we have the ID.\n    // If Stripe fails, the PENDING booking will eventually need to be cleaned up (e.g. cron job or webhook expiry).\n    \n    // Fallback to localhost if env var is missing (helpful for dev)\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\n    console.log('Using App URL:', appUrl);\n\n    const session = await stripe.checkout.sessions.create({\n      payment_method_types: ['card'],\n      line_items: [\n        {\n          price_data: {\n            currency: 'eur',\n            product_data: {\n              name: 'Sauna Reservation',\n              description: `${start.toLocaleString()} - ${end.toLocaleString()}`,\n            },\n            unit_amount: priceInCents,\n          },\n          quantity: 1,\n        },\n      ],\n      mode: 'payment',\n      success_url: `${appUrl}/success?session_id={CHECKOUT_SESSION_ID}`,\n      cancel_url: `${appUrl}/cancel`,\n      metadata: {\n        bookingId: booking.id, // Critical: Link Stripe session to our Booking\n      },\n      customer_email: userEmail,\n    });\n\n    if (!session.url) {\n      throw new Error('Failed to create Stripe session URL.');\n    }\n\n    // 4. Update booking with Stripe Session ID\n    // This allows us to look up the booking when the Stripe Webhook fires.\n    await prisma.booking.update({\n      where: { id: booking.id },\n      data: { stripeSessionId: session.id },\n    });\n\n    return { success: true, url: session.url };\n\n  } catch (error) {\n    console.error('Create Booking Error:', error);\n    \n    // Distinguish expected validation errors from system errors\n    if (error instanceof PricingError) {\n       return { success: false, error: error.message };\n    }\n    \n    // Return a generic error for safety, or specific if it's an expected \"Slot taken\" error\n    const message = error instanceof Error ? error.message : 'An unexpected error occurred.';\n    return { success: false, error: message };\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MikaS%C3%A4rkioja/Documents/Ty%C3%B6kansio/Cursor/SaunaReservation/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createBooking as '40e558c964b00310a5a13d8d96defbb8470f6960a7'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}